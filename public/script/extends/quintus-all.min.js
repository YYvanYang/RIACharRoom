var Quintus=function t(i){var e=function(t,i,s){return e.select(t,i,s)};e.select=function(){},e.include=function(i){return e._each(e._normalizeArg(i),function(i){var s=t[i]||i;if(!e._isFunction(s))throw"Invalid Module:"+i;s(e)}),e},e._normalizeArg=function(t){return e._isString(t)&&(t=t.replace(/\s+/g,"").split(",")),e._isArray(t)||(t=[t]),t},e._extend=function(t,i){if(!i)return t;for(var e in i)t[e]=i[e];return t},e._clone=function(t){return e._extend({},t)},e._defaults=function(t,i){if(!i)return t;for(var e in i)void 0===t[e]&&(t[e]=i[e]);return t},e._has=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e._isString=function(t){return"string"==typeof t},e._isNumber=function(t){return"[object Number]"===Object.prototype.toString.call(t)},e._isFunction=function(t){return"[object Function]"===Object.prototype.toString.call(t)},e._isObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},e._isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},e._isUndefined=function(t){return void 0===t},e._popProperty=function(t,i){var e=t[i];return delete t[i],e},e._each=function(t,i,e){if(null!=t)if(t.forEach)t.forEach(i,e);else if(t.length===+t.length)for(var s=0,n=t.length;n>s;s++)i.call(e,t[s],s,t);else for(var o in t)i.call(e,t[o],o,t)},e._invoke=function(t,i,e,s){if(null!=t)for(var n=0,o=t.length;o>n;n++)t[n][i](e,s)},e._detect=function(t,i,e,s,n){var o;if(null!=t){if(t.length===+t.length){for(var r=0,a=t.length;a>r;r++)if(o=i.call(e,t[r],r,s,n))return o;return!1}for(var h in t)if(o=i.call(e,t[h],h,s,n))return o;return!1}},e._map=function(t,i,s){var n=[];return null==t?n:t.map?t.map(i,s):(e._each(t,function(t,e,o){n[n.length]=i.call(s,t,e,o)}),t.length===+t.length&&(n.length=t.length),n)},e._uniq=function(t){t=t.slice().sort();for(var i=[],e=null,s=0;s<t.length;s++)void 0!==t[s]&&e!==t[s]&&i.push(t[s]),e=t[s];return i},e._shuffle=function(t){var s,i=[];return e._each(t,function(t,e){s=Math.floor(Math.random()*(e+1)),i[e]=i[s],i[s]=t}),i},e._keys=Object.keys||function(t){if(e._isObject(t))throw new TypeError("Invalid object");var i=[];for(var s in t)e._has(t,s)&&(i[i.length]=s);return i},e._range=function(t,i,e){e=e||1;for(var s=Math.max(Math.ceil((i-t)/e),0),n=0,o=new Array(s);s>n;)o[n++]=t,t+=e;return o};var s=0;return e._uniqueId=function(){return s++},e.options={imagePath:"images/",audioPath:"audio/",dataPath:"data/",audioSupported:["mp3","ogg"],sound:!0,frameTimeLimit:100},i&&e._extend(e.options,i),e.gameLoop=function(t){return e.lastGameLoopFrame=(new Date).getTime(),e.loop=!0,e._loopFrame=0,e.gameLoopCallbackWrapper=function(){var i=(new Date).getTime();e._loopFrame++,e.loop=window.requestAnimationFrame(e.gameLoopCallbackWrapper);var s=i-e.lastGameLoopFrame;s>e.options.frameTimeLimit&&(s=e.options.frameTimeLimit),t.apply(e,[s/1e3]),e.lastGameLoopFrame=i},window.requestAnimationFrame(e.gameLoopCallbackWrapper),e},e.pauseGame=function(){e.loop&&window.cancelAnimationFrame(e.loop),e.loop=null},e.unpauseGame=function(){e.loop||(e.lastGameLoopFrame=(new Date).getTime(),e.loop=window.requestAnimationFrame(e.gameLoopCallbackWrapper))},function(){var t=!1,i=/xyz/.test(function(){})?/\b_super\b/:/.*/;e.Class=function(){},e.Class.prototype.isA=function(t){return this.className===t},e.Class.extend=function(s,n,o){function l(t,i){return function(){var e=this._super;this._super=r[t];var s=i.apply(this,arguments);return this._super=e,s}}function u(){!t&&this.init&&this.init.apply(this,arguments)}e._isString(s)||(o=n,n=s,s=null);var r=this.prototype,a=this;t=!0;var h=new a;t=!1;for(var c in n)h[c]="function"==typeof n[c]&&"function"==typeof r[c]&&i.test(n[c])?l(c,n[c]):n[c];return u.prototype=h,u.prototype.constructor=u,u.extend=e.Class.extend,o&&e._extend(u,o),s&&(e[s]=u,u.prototype.className=s,u.className=s),u}}(),e.Class.extend("Evented",{on:function(t,i,s){if(e._isArray(t)||-1!==t.indexOf(",")){t=e._normalizeArg(t);for(var n=0;n<t.length;n++)this.on(t[n],i,s)}else s||(s=i,i=null),s||(s=t),e._isString(s)&&(s=(i||this)[s]),this.listeners=this.listeners||{},this.listeners[t]=this.listeners[t]||[],this.listeners[t].push([i||this,s]),i&&(i.binds||(i.binds=[]),i.binds.push([this,t,s]))},trigger:function(t,i){if(this.listeners&&this.listeners[t])for(var e=0,s=this.listeners[t].length;s>e;e++){var n=this.listeners[t][e];n[1].call(n[0],i)}},off:function(t,i,s){if(i){e._isString(s)&&i[s]&&(s=i[s]);var n=this.listeners&&this.listeners[t];if(n)for(var o=n.length-1;o>=0;o--)n[o][0]===i&&(s&&s!==n[o][1]||this.listeners[t].splice(o,1))}else this.listeners[t]&&delete this.listeners[t]},debind:function(){if(this.binds)for(var t=0,i=this.binds.length;i>t;t++){var e=this.binds[t],s=e[0],n=e[1];s.off(n,this)}}}),e.components={},e.Evented.extend("Component",{init:function(t){this.entity=t,this.extend&&e._extend(t,this.extend),t[this.name]=this,t.activeComponents.push(this.componentName),t.stage&&t.stage.addToList&&t.stage.addToList(this.componentName,t),this.added&&this.added()},destroy:function(){if(this.extend)for(var t=e._keys(this.extend),i=0,s=t.length;s>i;i++)delete this.entity[t[i]];delete this.entity[this.name];var n=this.entity.activeComponents.indexOf(this.componentName);-1!==n&&(this.entity.activeComponents.splice(n,1),this.entity.stage&&this.entity.stage.addToList&&this.entity.stage.addToLists(this.componentName,this.entity)),this.debind(),this.destroyed&&this.destroyed()}}),e.Evented.extend("GameObject",{has:function(t){return this[t]?!0:!1},add:function(t){t=e._normalizeArg(t),this.activeComponents||(this.activeComponents=[]);for(var i=0,s=t.length;s>i;i++){var n=t[i],o=e.components[n];if(!this.has(n)&&o){var r=new o(this);this.trigger("addComponent",r)}}return this},del:function(t){t=e._normalizeArg(t);for(var i=0,s=t.length;s>i;i++){var n=t[i];n&&this.has(n)&&(this.trigger("delComponent",this[n]),this[n].destroy())}return this},destroy:function(){this.isDestroyed||(this.trigger("destroyed"),this.debind(),this.stage&&this.stage.remove&&this.stage.remove(this),this.isDestroyed=!0,this.destroyed&&this.destroyed())}}),e.component=function(t,i){return i?(i.name=t,i.componentName="."+t,e.components[t]=e.Component.extend(t+"Component",i)):e.components[t]},e.GameObject.extend("GameState",{init:function(t){this.p=e._extend({},t),this.listeners={}},reset:function(t){this.init(t),this.trigger("reset")},_triggerProperty:function(t,i){this.p[i]!==t&&(this.p[i]=t,this.trigger("change."+i,t))},set:function(t,i){e._isObject(t)?e._each(t,this._triggerProperty,this):this._triggerProperty(i,t),this.trigger("change")},inc:function(t,i){this.set(t,this.get(t)+i)},dec:function(t,i){this.set(t,this.get(t)-i)},get:function(t){return this.p[t]}}),e.state=new e.GameState,e.reset=function(){e.state.reset()},e.touchDevice="ontouchstart"in document,e.setup=function(t,i){e._isObject(t)&&(i=t,t=null),i=i||{},t=t||"quintus",e.el=e._isString(t)?document.getElementById(t):t,e.el||(e.el=document.createElement("canvas"),e.el.width=i.width||320,e.el.height=i.height||420,e.el.id=t,document.body.appendChild(e.el));var s=parseInt(e.el.width,10),n=parseInt(e.el.height,10),o=i.maxWidth||5e3,r=i.maxHeight||5e3,a=i.resampleWidth,h=i.resampleHeight,l=i.upsampleWidth,c=i.upsampleHeight;i.maximize===!0||e.touchDevice&&"touch"===i.maximize?(document.body.style.padding=0,document.body.style.margin=0,s=Math.min(window.innerWidth,o),n=Math.min(window.innerHeight-5,r),e.touchDevice&&(e.el.style.height=2*n+"px",window.scrollTo(0,1),s=Math.min(window.innerWidth,o),n=Math.min(window.innerHeight,r))):e.touchDevice&&window.scrollTo(0,1),l&&l>=s||c&&c>=n?(e.el.style.height=n+"px",e.el.style.width=s+"px",e.el.width=2*s,e.el.height=2*n):(a&&s>a||h&&n>h)&&e.touchDevice?(e.el.style.height=n+"px",e.el.style.width=s+"px",e.el.width=s/2,e.el.height=n/2):(e.el.style.height=n+"px",e.el.style.width=s+"px",e.el.width=s,e.el.height=n);var u=e.el.parentNode;return u&&(e.wrapper=document.createElement("div"),e.wrapper.id=t+"_container",e.wrapper.style.width=s+"px",e.wrapper.style.margin="0 auto",e.wrapper.style.position="relative",u.insertBefore(e.wrapper,e.el),e.wrapper.appendChild(e.el)),e.el.style.position="relative",e.ctx=e.el.getContext&&e.el.getContext("2d"),e.width=parseInt(e.el.width,10),e.height=parseInt(e.el.height,10),e.cssWidth=s,e.cssHeight=n,window.addEventListener("orientationchange",function(){setTimeout(function(){window.scrollTo(0,1)},0)}),e},e.clear=function(){e.clearColor?(e.ctx.globalAlpha=1,e.ctx.fillStyle=e.clearColor,e.ctx.fillRect(0,0,e.width,e.height)):e.ctx.clearRect(0,0,e.width,e.height)},e.setImageSmoothing=function(t){e.ctx.mozImageSmoothingEnabled=t,e.ctx.webkitImageSmoothingEnabled=t,e.ctx.msImageSmoothingEnabled=t,e.ctx.imageSmoothingEnabled=t},e.imageData=function(t){var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var e=i.getContext("2d");return e.drawImage(t,0,0),e.getImageData(0,0,t.width,t.height)},e.assetTypes={png:"Image",jpg:"Image",gif:"Image",jpeg:"Image",ogg:"Audio",wav:"Audio",m4a:"Audio",mp3:"Audio"},e._fileExtension=function(t){var i=t.split("."),e=i[i.length-1].toLowerCase();return e},e.assetType=function(t){var i=e._fileExtension(t),s=e.assetTypes[i];return"Audio"===s&&e.audio&&"WebAudio"===e.audio.type&&(s="WebAudio"),s||"Other"},e.assetUrl=function(t,i){var s="";return e.options.development&&(s=(/\?/.test(i)?"&":"?")+"_t="+(new Date).getTime()),/^https?:\/\//.test(i)||"/"===i[0]?i+s:t+i+s},e.loadAssetImage=function(t,i,s,n){var o=new Image;o.onload=function(){s(t,o)},o.onerror=n,o.src=e.assetUrl(e.options.imagePath,i)},e.audioMimeTypes={mp3:"audio/mpeg",ogg:'audio/ogg; codecs="vorbis"',m4a:"audio/m4a",wav:"audio/wav"},e._audioAssetExtension=function(){if(e._audioAssetPreferredExtension)return e._audioAssetPreferredExtension;var t=new Audio;return e._audioAssetPreferredExtension=e._detect(e.options.audioSupported,function(i){return t.canPlayType(e.audioMimeTypes[i])?i:null})},e.loadAssetAudio=function(t,i,s,n){if(!document.createElement("audio").play||!e.options.sound)return void s(t,null);var o=e._removeExtension(i),r=e._audioAssetExtension(),h=new Audio;return r?(h.addEventListener("error",n),e.touchDevice||h.addEventListener("canplaythrough",function(){s(t,h)}),h.src=e.assetUrl(e.options.audioPath,o+"."+r),h.load(),void(e.touchDevice&&s(t,h))):void s(t,null)},e.loadAssetWebAudio=function(t,i,s,n){var o=new XMLHttpRequest,r=e._removeExtension(i),a=e._audioAssetExtension();o.open("GET",e.assetUrl(e.options.audioPath,r+"."+a),!0),o.responseType="arraybuffer",o.onload=function(){o.response;e.audioContext.decodeAudioData(o.response,function(i){s(t,i)},n)},o.send()},e.loadAssetOther=function(t,i,s,n){var o=new XMLHttpRequest,r=i.split("."),a=r[r.length-1].toLowerCase();o.onreadystatechange=function(){4===o.readyState&&(200===o.status?"json"===a?s(t,JSON.parse(o.responseText)):s(t,o.responseText):n())},o.open("GET",e.assetUrl(e.options.dataPath,i),!0),o.send(null)},e._removeExtension=function(t){return t.replace(/\.(\w{3,4})$/,"")},e.assets={},e.asset=function(t){return e.assets[t]},e.load=function(t,i,s){var n={};s||(s={});var o=s.progressCallback,r=!1,a=function(t){r=!0,(s.errorCallback||function(t){throw"Error Loading: "+t})(t)};e._isString(t)&&(t=e._normalizeArg(t)),e._isArray(t)?e._each(t,function(t){e._isObject(t)?e._extend(n,t):n[t]=t}):n=t;var h=e._keys(n).length,l=h,c=function(t,s,n){r||((!e.assets[t]||n)&&(e.assets[t]=s,l--,o&&o(h-l,h)),0===l&&i&&i.apply(e))};e._each(n,function(t,i){var s=e.assetType(t);e.assets[i]?c(i,e.assets[i],!0):e["loadAsset"+s](i,t,c,function(){a(t)})})},e.preloads=[],e.preload=function(t,i){e._isFunction(t)?(e.load(e._uniq(e.preloads),t,i),e.preloads=[]):e.preloads=e.preloads.concat(t)},e.matrices2d=[],e.matrix2d=function(){return e.matrices2d.length>0?e.matrices2d.pop().identity():new e.Matrix2D},e.Matrix2D=e.Class.extend({init:function(t){t?(this.m=[],this.clone(t)):this.m=[1,0,0,0,1,0]},identity:function(){var t=this.m;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,this},clone:function(t){var i=this.m,e=t.m;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],this},multiply:function(t){var i=this.m,e=t.m,s=i[0]*e[0]+i[1]*e[3],n=i[0]*e[1]+i[1]*e[4],o=i[0]*e[2]+i[1]*e[5]+i[2],r=i[3]*e[0]+i[4]*e[3],a=i[3]*e[1]+i[4]*e[4],h=i[3]*e[2]+i[4]*e[5]+i[5];return i[0]=s,i[1]=n,i[2]=o,i[3]=r,i[4]=a,i[5]=h,this},rotate:function(t){if(0===t)return this;var i=Math.cos(t),e=Math.sin(t),s=this.m,n=s[0]*i+s[1]*e,o=s[0]*-e+s[1]*i,r=s[3]*i+s[4]*e,a=s[3]*-e+s[4]*i;return s[0]=n,s[1]=o,s[3]=r,s[4]=a,this},rotateDeg:function(t){return 0===t?this:this.rotate(Math.PI*t/180)},scale:function(t,i){var e=this.m;return void 0===i&&(i=t),e[0]*=t,e[1]*=i,e[3]*=t,e[4]*=i,this},translate:function(t,i){var e=this.m;return e[2]+=e[0]*t+e[1]*i,e[5]+=e[3]*t+e[4]*i,this},transform:function(t,i){return[t*this.m[0]+i*this.m[1]+this.m[2],t*this.m[3]+i*this.m[4]+this.m[5]]},transformPt:function(t){var i=t.x,e=t.y;return t.x=i*this.m[0]+e*this.m[1]+this.m[2],t.y=i*this.m[3]+e*this.m[4]+this.m[5],t},transformArr:function(t,i){var e=t[0],s=t[1];return i[0]=e*this.m[0]+s*this.m[1]+this.m[2],i[1]=e*this.m[3]+s*this.m[4]+this.m[5],i},transformX:function(t,i){return t*this.m[0]+i*this.m[1]+this.m[2]},transformY:function(t,i){return t*this.m[3]+i*this.m[4]+this.m[5]},release:function(){return e.matrices2d.push(this),null},setContextTransform:function(t){var i=this.m;t.transform(i[0],i[3],i[1],i[4],i[2],i[5])}}),e};!function(){for(var t=0,i=["ms","moz","webkit","o"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i){var s=(new Date).getTime(),n=Math.max(0,16-(s-t)),o=window.setTimeout(function(){i(s+n)},n);return t=s+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),Quintus["2D"]=function(t){t.component("viewport",{added:function(){this.entity.on("prerender",this,"prerender"),this.entity.on("render",this,"postrender"),this.x=0,this.y=0,this.offsetX=0,this.offsetY=0,this.centerX=t.width/2,this.centerY=t.height/2,this.scale=1},extend:{follow:function(t,i,e){this.off("poststep",this.viewport,"follow"),this.viewport.directions=i||{x:!0,y:!0},this.viewport.following=t,this.viewport.boundingBox=e,this.on("poststep",this.viewport,"follow"),this.viewport.follow(!0)},unfollow:function(){this.off("poststep",this.viewport,"follow")},centerOn:function(t,i){this.viewport.centerOn(t,i)},moveTo:function(t,i){return this.viewport.moveTo(t,i)}},follow:function(i){var e=t._isFunction(this.directions.x)?this.directions.x(this.following):this.directions.x,s=t._isFunction(this.directions.y)?this.directions.y(this.following):this.directions.y;this[i===!0?"centerOn":"softCenterOn"](e?this.following.p.x+this.following.p.w/2-this.offsetX:void 0,s?this.following.p.y+this.following.p.h/2-this.offsetY:void 0)},offset:function(t,i){this.offsetX=t,this.offsetY=i},softCenterOn:function(i,e){if(void 0!==i){var s=(i-t.width/2/this.scale-this.x)/3;this.boundingBox?this.x+s<this.boundingBox.minX?this.x=this.boundingBox.minX/this.scale:this.x+s>(this.boundingBox.maxX-t.width)/this.scale?this.x=(this.boundingBox.maxX-t.width)/this.scale:this.x+=s:this.x+=s}if(void 0!==e){var n=(e-t.height/2/this.scale-this.y)/3;this.boundingBox?this.y+n<this.boundingBox.minY?this.y=this.boundingBox.minY/this.scale:this.y+n>(this.boundingBox.maxY-t.height)/this.scale?this.y=(this.boundingBox.maxY-t.height)/this.scale:this.y+=n:this.y+=n}},centerOn:function(i,e){void 0!==i&&(this.x=i-t.width/2/this.scale),void 0!==e&&(this.y=e-t.height/2/this.scale)},moveTo:function(t,i){return void 0!==t&&(this.x=t),void 0!==i&&(this.y=i),this.entity},prerender:function(){this.centerX=this.x+t.width/2/this.scale,this.centerY=this.y+t.height/2/this.scale,t.ctx.save(),t.ctx.translate(Math.floor(t.width/2),Math.floor(t.height/2)),t.ctx.scale(this.scale,this.scale),t.ctx.translate(-Math.floor(this.centerX),-Math.floor(this.centerY))},postrender:function(){t.ctx.restore()}}),t.Sprite.extend("TileLayer",{init:function(t){this._super(t,{tileW:32,tileH:32,blockTileW:10,blockTileH:10,type:1,renderAlways:!0}),this.p.dataAsset&&this.load(this.p.dataAsset),this.setDimensions(),this.blocks=[],this.p.blockW=this.p.tileW*this.p.blockTileW,this.p.blockH=this.p.tileH*this.p.blockTileH,this.colBounds={},this.directions=["top","left","right","bottom"],this.tileProperties={},this.collisionObject={p:{w:this.p.tileW,h:this.p.tileH,cx:this.p.tileW/2,cy:this.p.tileH/2}},this.tileCollisionObjects={},this.collisionNormal={separate:[]},this._generateCollisionObjects()},_generateCollisionObjects:function(){function e(t){return[t[0]*i.p.tileW-i.p.tileW/2,t[1]*i.p.tileH-i.p.tileH/2]}var i=this;if(this.sheet()&&this.sheet().frameProperties){var s=this.sheet().frameProperties;for(var n in s){var o=this.tileCollisionObjects[n]={p:t._clone(this.collisionObject.p)};t._extend(o.p,s[n]),o.p.points&&(o.p.points=t._map(o.p.points,e)),this.tileCollisionObjects[n]=o}}},load:function(i){var n,e=i.split("."),s=e[e.length-1].toLowerCase();if("json"!==s)throw"file type not supported";n=t._isString(i)?t.asset(i):i,this.p.tiles=n},setDimensions:function(){var t=this.p.tiles;t&&(this.p.rows=t.length,this.p.cols=t[0].length,this.p.w=this.p.cols*this.p.tileW,this.p.h=this.p.rows*this.p.tileH)},getTile:function(t,i){return this.p.tiles[i]&&this.p.tiles[i][t]},getTileProperty:function(t,i){return void 0!==this.tileProperties[t]?this.tileProperties[t][i]:void 0},getTileProperties:function(t){return void 0!==this.tileProperties[t]?this.tileProperties[t]:{}},getTilePropertyAt:function(t,i,e){return this.getTileProperty(this.getTile(t,i),e)},getTilePropertiesAt:function(t,i){return this.getTileProperties(this.getTile(t,i))},tileHasProperty:function(t,i){return void 0!==this.getTileProperty(t,i)},setTile:function(t,i,e){var s=this.p,n=Math.floor(t/s.blockTileW),o=Math.floor(i/s.blockTileH);t>=0&&t<this.p.cols&&i>=0&&i<this.p.rows&&(this.p.tiles[i][t]=e,this.blocks[o]&&(this.blocks[o][n]=null))},tilePresent:function(t,i){return this.p.tiles[i]&&this.collidableTile(this.p.tiles[i][t])},drawableTile:function(t){return t>0},collidableTile:function(t){return t>0},getCollisionObject:function(t,i){var n,e=this.p,s=this.getTile(t,i);return n=void 0!==this.tileCollisionObjects[s]?this.tileCollisionObjects[s]:this.collisionObject,n.p.x=t*e.tileW+e.x+e.tileW/2,n.p.y=i*e.tileH+e.y+e.tileH/2,n},collide:function(i){var l,c,e=this.p,s=i.c||i.p,n=Math.floor((s.x-s.cx-e.x)/e.tileW),o=Math.floor((s.y-s.cy-e.y)/e.tileH),r=Math.ceil((s.x-s.cx+s.w-e.x)/e.tileW),a=Math.ceil((s.y-s.cy+s.h-e.y)/e.tileH),h=this.collisionNormal;h.collided=!1;for(var u=o;a>=u;u++)for(var f=n;r>=f;f++)this.tilePresent(f,u)&&(c=this.getCollisionObject(f,u),l=t.collision(i,c),l&&l.magnitude>0&&(c.p.sensor?(c.tile=this.getTile(f,u),i.trigger&&i.trigger("sensor.tile",c)):(!h.collided||h.magnitude<l.magnitude)&&(h.collided=!0,h.separate[0]=l.separate[0],h.separate[1]=l.separate[1],h.magnitude=l.magnitude,h.distance=l.distance,h.normalX=l.normalX,h.normalY=l.normalY,h.tileX=f,h.tileY=u,h.tile=this.getTile(f,u),void 0!==i.p.collisions&&i.p.collisions.push(h))));return h.collided?h:!1},prerenderBlock:function(t,i){var e=this.p,s=e.tiles,n=this.sheet(),o=t*e.blockTileW,r=i*e.blockTileH;if(!(0>o||o>=this.p.cols||0>r||r>=this.p.rows)){var a=document.createElement("canvas"),h=a.getContext("2d");a.width=e.blockW,a.height=e.blockH,this.blocks[i]=this.blocks[i]||{},this.blocks[i][t]=a;for(var l=0;l<e.blockTileH;l++)if(s[l+r])for(var c=0;c<e.blockTileW;c++)this.drawableTile(s[l+r][c+o])&&n.draw(h,c*e.tileW,l*e.tileH,s[l+r][c+o])}},drawBlock:function(t,i,e){var s=this.p,n=Math.floor(i*s.blockW+s.x),o=Math.floor(e*s.blockH+s.y);this.blocks[e]&&this.blocks[e][i]||this.prerenderBlock(i,e),this.blocks[e]&&this.blocks[e][i]&&t.drawImage(this.blocks[e][i],n,o)},draw:function(i){for(var e=this.p,s=this.stage.viewport,n=s?s.scale:1,o=s?s.x:0,r=s?s.y:0,a=t.width/n,h=t.height/n,l=Math.floor((o-e.x)/e.blockW),c=Math.floor((r-e.y)/e.blockH),u=Math.floor((o+a-e.x)/e.blockW),f=Math.floor((r+h-e.y)/e.blockH),p=c;f>=p;p++)for(var d=l;u>=d;d++)this.drawBlock(i,d,p)}}),t.gravityY=9.8*100,t.gravityX=0,t.component("2d",{added:function(){var i=this.entity;t._defaults(i.p,{vx:0,vy:0,ax:0,ay:0,gravity:1,collisionMask:t.SPRITE_DEFAULT}),i.on("step",this,"step"),i.on("hit",this,"collision")},collision:function(t){var e=this.entity,s=e.p;if(t.obj.p&&t.obj.p.sensor)return void t.obj.trigger("sensor",e);t.impact=0;var o=Math.abs(s.vx),r=Math.abs(s.vy);s.x-=t.separate[0],s.y-=t.separate[1],t.normalY<-.3&&(!s.skipCollide&&s.vy>0&&(s.vy=0),t.impact=r,e.trigger("bump.bottom",t)),t.normalY>.3&&(!s.skipCollide&&s.vy<0&&(s.vy=0),t.impact=r,e.trigger("bump.top",t)),t.normalX<-.3&&(!s.skipCollide&&s.vx>0&&(s.vx=0),t.impact=o,e.trigger("bump.right",t)),t.normalX>.3&&(!s.skipCollide&&s.vx<0&&(s.vx=0),t.impact=o,e.trigger("bump.left",t))},step:function(i){for(var e=this.entity.p,s=i;s>0;)i=Math.min(1/30,s),e.vx+=e.ax*i+(void 0===e.gravityX?t.gravityX:e.gravityX)*i*e.gravity,e.vy+=e.ay*i+(void 0===e.gravityY?t.gravityY:e.gravityY)*i*e.gravity,e.x+=e.vx*i,e.y+=e.vy*i,this.entity.stage.collide(this.entity),s-=i}}),t.component("aiBounce",{added:function(){this.entity.on("bump.right",this,"goLeft"),this.entity.on("bump.left",this,"goRight")},goLeft:function(t){this.entity.p.vx=-t.impact,this.entity.p.flip="right"===this.entity.p.defaultDirection?"x":!1},goRight:function(t){this.entity.p.vx=t.impact,this.entity.p.flip="left"===this.entity.p.defaultDirection?"x":!1}})},Quintus.Anim=function(t){t._animations={},t.animations=function(i,e){t._animations[i]||(t._animations[i]={}),t._extend(t._animations[i],e)},t.animation=function(i,e){return t._animations[i]&&t._animations[i][e]},t.component("animation",{added:function(){var t=this.entity.p;t.animation=null,t.animationPriority=-1,t.animationFrame=0,t.animationTime=0,this.entity.on("step",this,"step")},extend:{play:function(t,i,e){this.animation.play(t,i,e)}},step:function(i){var e=this.entity,s=e.p;if(s.animation){var n=t.animation(s.sprite,s.animation),o=n.rate||s.rate,r=0;if(s.animationTime+=i,s.animationChanged?s.animationChanged=!1:(s.animationTime+=i,s.animationTime>o&&(r=Math.floor(s.animationTime/o),s.animationTime-=r*o,s.animationFrame+=r)),r>0){if(s.animationFrame>=n.frames.length){if(n.loop===!1||n.next)return s.animationFrame=n.frames.length-1,e.trigger("animEnd"),e.trigger("animEnd."+s.animation),s.animation=null,s.animationPriority=-1,n.trigger&&e.trigger(n.trigger,n.triggerData),void(n.next&&this.play(n.next,n.nextPriority));e.trigger("animLoop"),e.trigger("animLoop."+s.animation),s.animationFrame=s.animationFrame%n.frames.length}e.trigger("animFrame")}s.sheet=n.sheet||s.sheet,s.frame=n.frames[s.animationFrame],n.hasOwnProperty("flip")&&(s.flip=n.flip)}},play:function(t,i,e){var s=this.entity,n=s.p;i=i||0,t!==n.animation&&i>=n.animationPriority&&(void 0===e&&(e=!0),n.animation=t,e&&(n.animationChanged=!0,n.animationTime=0,n.animationFrame=0),n.animationPriority=i,s.trigger("anim"),s.trigger("anim."+n.animation))}}),t.Sprite.extend("Repeater",{init:function(i){this._super(t._defaults(i,{speedX:1,speedY:1,repeatY:!0,repeatX:!0,renderAlways:!0,type:0})),this.p.repeatW=this.p.repeatW||this.p.w,this.p.repeatH=this.p.repeatH||this.p.h},draw:function(i){var c,u,f,e=this.p,s=this.asset(),n=this.sheet(),o=this.stage.viewport?this.stage.viewport.scale:1,r=Math.floor(this.stage.viewport?this.stage.viewport.x:0),a=Math.floor(this.stage.viewport?this.stage.viewport.y:0),h=Math.floor(e.x+r*this.p.speedX),l=Math.floor(e.y+a*this.p.speedY);for(e.repeatX?(c=-h%e.repeatW,c>0&&(c-=e.repeatW)):c=e.x-r,e.repeatY?(u=-l%e.repeatH,u>0&&(u-=e.repeatH)):u=e.y-a,f=c;u<t.height/o;){for(c=f;c<t.width/o&&(n?n.draw(i,c+r,u+a,e.frame):i.drawImage(s,c+r,u+a),c+=e.repeatW,e.repeatX););if(u+=e.repeatH,!e.repeatY)break}}}),t.Tween=t.Class.extend({init:function(i,e,s,n,o){t._isObject(n)&&(o=n,n=t.Easing.Linear),t._isObject(s)&&(o=s,s=1),this.entity=i,this.duration=s||1,this.time=0,this.options=o||{},this.delay=this.options.delay||0,this.easing=n||this.options.easing||t.Easing.Linear,this.startFrame=t._loopFrame+1,this.properties=e,this.start={},this.diff={}},step:function(i){var e;if(this.startFrame>t._loopFrame)return!0;if(this.delay>=i)return this.delay-=i,!0;if(this.delay>0&&(i-=this.delay,this.delay=0),0===this.time){var s=this.entity,n=this.properties;this.p=s instanceof t.Stage?s.viewport:s.p;for(e in n)this.start[e]=this.p[e],t._isUndefined(this.start[e])||(this.diff[e]=n[e]-this.start[e])}this.time+=i;var o=Math.min(1,this.time/this.duration),r=this.easing(o);for(e in this.start)t._isUndefined(this.p[e])||(this.p[e]=this.start[e]+this.diff[e]*r);return o>=1&&this.options.callback&&this.options.callback.apply(this.entity),1>o}}),t.Easing={Linear:function(t){return t},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}}},t.component("tween",{added:function(){this._tweens=[],this.entity.on("step",this,"step")},extend:{animate:function(i,e,s,n){return this.tween._tweens.push(new t.Tween(this,i,e,s,n)),this},chain:function(i,e,s,n){t._isObject(s)&&(n=s,s=t.Easing.Linear);var o=this.tween._tweens.length;if(o>0){var r=this.tween._tweens[o-1];n=n||{},n.delay=r.duration-r.time+r.delay}return this.animate(i,e,s,n),this},stop:function(){return this.tween._tweens.length=0,this}},step:function(t){for(var i=0;i<this._tweens.length;i++)this._tweens[i].step(t)||(this._tweens.splice(i,1),i--)}})},Quintus.Audio=function(t){t.audio={channels:[],channelMax:t.options.channelMax||10,active:{},play:function(){}},t.hasWebAudio="undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext,t.hasWebAudio&&(t.audioContext="undefined"!=typeof AudioContext?new AudioContext:new window.webkitAudioContext),t.enableSound=function(){return t.hasWebAudio?t.audio.enableWebAudioSound():t.audio.enableHTML5Sound(),t},t.audio.enableWebAudioSound=function(){t.audio.type="WebAudio",t.audio.soundID=0,t.audio.playingSounds={},t.audio.removeSound=function(i){delete t.audio.playingSounds[i]},t.audio.play=function(i,e){var s=(new Date).getTime();if(!(t.audio.active[i]&&t.audio.active[i]>s)){e&&e.debounce?t.audio.active[i]=s+e.debounce:delete t.audio.active[i];var n=t.audio.soundID++,o=t.audioContext.createBufferSource();o.buffer=t.asset(i),o.connect(t.audioContext.destination),e&&e.loop?o.loop=!0:setTimeout(function(){t.audio.removeSound(n)},1e3*o.buffer.duration),o.assetName=i,o.start?o.start(0):o.noteOn(0),t.audio.playingSounds[n]=o}},t.audio.stop=function(i){for(var e in t.audio.playingSounds){var s=t.audio.playingSounds[e];i&&i!==s.assetName||(s.stop?s.stop(0):s.noteOff(0))}}},t.audio.enableHTML5Sound=function(){t.audio.type="HTML5";for(var i=0;i<t.audio.channelMax;i++)t.audio.channels[i]={},t.audio.channels[i].channel=new Audio,t.audio.channels[i].finished=-1;t.audio.play=function(i,e){var s=(new Date).getTime();if(!(t.audio.active[i]&&t.audio.active[i]>s)){e&&e.debounce?t.audio.active[i]=s+e.debounce:delete t.audio.active[i];for(var n=0;n<t.audio.channels.length;n++)if(!t.audio.channels[n].loop&&t.audio.channels[n].finished<s){t.audio.channels[n].channel.src=t.asset(i).src,e&&e.loop?(t.audio.channels[n].loop=!0,t.audio.channels[n].channel.loop=!0):t.audio.channels[n].finished=s+1e3*t.asset(i).duration,t.audio.channels[n].channel.load(),t.audio.channels[n].channel.play();break}}},t.audio.stop=function(i){for(var e=i?t.asset(i).src:null,s=(new Date).getTime(),n=0;n<t.audio.channels.length;n++)e&&t.audio.channels[n].channel.src!==e||!(t.audio.channels[n].loop||t.audio.channels[n].finished>=s)||(t.audio.channels[n].channel.pause(),t.audio.channels[n].loop=!1)}}},Quintus.Input=function(t){var i=t.KEY_NAMES={LEFT:37,RIGHT:39,SPACE:32,UP:38,DOWN:40,Z:90,X:88},e={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",SPACE:"fire",Z:"fire",X:"action"},s=[["left","<"],["right",">"],[],["action","b"],["fire","a"]],n=["up","right","down","left"];t.inputs={},t.joypad={};var o=!!("ontouchstart"in window);t.canvasToStageX=function(i,e){return i=i/t.cssWidth*t.width,e.viewport&&(i/=e.viewport.scale,i+=e.viewport.x),i},t.canvasToStageY=function(i,e){return i=i/t.cssWidth*t.width,e.viewport&&(i/=e.viewport.scale,i+=e.viewport.y),i},t.InputSystem=t.Evented.extend({keys:{},keypad:{},keyboardEnabled:!1,touchEnabled:!1,joypadEnabled:!1,bindKey:function(e,s){t.input.keys[i[e]||e]=s},enableKeyboard:function(){return this.keyboardEnabled?!1:(t.el.tabIndex=0,t.el.style.outline=0,t.el.addEventListener("keydown",function(i){if(t.input.keys[i.keyCode]){var e=t.input.keys[i.keyCode];t.inputs[e]=!0,t.input.trigger(e),t.input.trigger("keydown",i.keyCode)}i.preventDefault()},!1),t.el.addEventListener("keyup",function(i){if(t.input.keys[i.keyCode]){var e=t.input.keys[i.keyCode];t.inputs[e]=!1,t.input.trigger(e+"Up"),t.input.trigger("keyup",i.keyCode)}i.preventDefault()},!1),t.el.focus(),void(this.keyboardEnabled=!0))},keyboardControls:function(i){i=i||e,t._each(i,function(t,i){this.bindKey(i,t)},t.input),this.enableKeyboard()},_containerOffset:function(){t.input.offsetX=0,t.input.offsetY=0;var i=t.el;do t.input.offsetX+=i.offsetLeft,t.input.offsetY+=i.offsetTop;while(i=i.offsetParent)},touchLocation:function(i){var o,r,s=(t.el,i.offsetX),n=i.offsetY;return(t._isUndefined(s)||t._isUndefined(n))&&(s=i.layerX,n=i.layerY),(t._isUndefined(s)||t._isUndefined(n))&&(void 0===t.input.offsetX&&t.input._containerOffset(),s=i.pageX-t.input.offsetX,n=i.pageY-t.input.offsetY),o=t.width*s/t.cssWidth,r=t.height*n/t.cssHeight,{x:o,y:r}},touchControls:function(i){function e(e){for(var s=t.input.touchLocation(e),n=0,o=i.controls.length;o>n;n++)if(s.x<i.unit*(n+1))return i.controls[n][0]}function n(s){var o,r,a,h,l,n={};for(o=0,r=i.controls.length;r>o;o++)l=i.controls[o][0],t.inputs[l]&&(n[l]=!0),t.inputs[l]=!1;var c=s.touches?s.touches:[s];for(o=0,r=c.length;r>o;o++)a=c[o],h=e(a),h&&(t.inputs[h]=!0,n[h]?delete n[h]:t.input.trigger(h));for(l in n)t.input.trigger(l+"Up");return null}return this.touchEnabled?!1:o?(t.input.keypad=i=t._extend({left:0,gutter:10,controls:s,width:t.width,bottom:t.height},i),i.unit=i.width/i.controls.length,i.size=i.unit-2*i.gutter,this.touchDispatchHandler=function(t){n(t),t.preventDefault()},t._each(["touchstart","touchend","touchmove","touchcancel"],function(i){t.el.addEventListener(i,this.touchDispatchHandler)},this),void(this.touchEnabled=!0)):!1},disableTouchControls:function(){t._each(["touchstart","touchend","touchmove","touchcancel"],function(i){t.el.removeEventListener(i,this.touchDispatchHandler)},this),t.el.removeEventListener("touchstart",this.joypadStart),t.el.removeEventListener("touchmove",this.joypadMove),t.el.removeEventListener("touchend",this.joypadEnd),t.el.removeEventListener("touchcancel",this.joypadEnd),this.touchEnabled=!1},joypadControls:function(i){if(this.joypadEnabled)return!1;if(!o)return!1;var e=t.joypad=t._defaults(i||{},{size:50,trigger:20,center:25,color:"#CCC",background:"#000",alpha:.5,zone:t.width/2,joypadTouch:null,inputs:n,triggers:[]});this.joypadStart=function(i){if(null===e.joypadTouch){var s=i.changedTouches[0],n=t.input.touchLocation(s);n.x<e.zone&&(e.joypadTouch=s.identifier,e.centerX=n.x,e.centerY=n.y,e.x=null,e.y=null)}},this.joypadMove=function(i){if(null!==e.joypadTouch)for(var s=i,n=0,o=s.changedTouches.length;o>n;n++){var r=s.changedTouches[n];if(r.identifier===e.joypadTouch){var a=t.input.touchLocation(r),h=a.x-e.centerX,l=a.y-e.centerY,c=Math.sqrt(h*h+l*l),u=Math.max(1,c/e.size),f=Math.atan2(h,l);u>1&&(h/=u,l/=u,c/=u);for(var p=[l<-e.trigger,h>e.trigger,l>e.trigger,h<-e.trigger],d=0;d<p.length;d++){var g=e.inputs[d];p[d]?(t.inputs[g]=!0,e.triggers[d]||t.input.trigger(g)):(t.inputs[g]=!1,e.triggers[d]&&t.input.trigger(g+"Up"))}t._extend(e,{dx:h,dy:l,x:e.centerX+h,y:e.centerY+l,dist:c,ang:f,triggers:p});
break}}i.preventDefault()},this.joypadEnd=function(i){var s=i;if(null!==e.joypadTouch)for(var n=0,o=s.changedTouches.length;o>n;n++){var r=s.changedTouches[n];if(r.identifier===e.joypadTouch){for(var a=0;a<e.triggers.length;a++){var h=e.inputs[a];t.inputs[h]=!1,e.triggers[a]&&t.input.trigger(h+"Up")}e.joypadTouch=null;break}}i.preventDefault()},t.el.addEventListener("touchstart",this.joypadStart),t.el.addEventListener("touchmove",this.joypadMove),t.el.addEventListener("touchend",this.joypadEnd),t.el.addEventListener("touchcancel",this.joypadEnd),this.joypadEnabled=!0},mouseControls:function(i){i=i||{};var e=i.stageNum||0,s=i.mouseX||"mouseX",n=i.mouseY||"mouseY",o=i.cursor||"off",r={};"on"!==o&&(t.el.style.cursor="off"===o?"none":o),t.inputs[s]=0,t.inputs[n]=0,t._mouseMove=function(i){i.preventDefault();var o=i.touches?i.touches[0]:i,h=(t.el,o.offsetX),l=o.offsetY,f=t.stage(e);(t._isUndefined(h)||t._isUndefined(l))&&(h=o.layerX,l=o.layerY),(t._isUndefined(h)||t._isUndefined(l))&&(void 0===t.input.offsetX&&t.input._containerOffset(),h=o.pageX-t.input.offsetX,l=o.pageY-t.input.offsetY),f&&(r.x=t.canvasToStageX(h,f),r.y=t.canvasToStageY(l,f),t.inputs[s]=r.x,t.inputs[n]=r.y,t.input.trigger("mouseMove",r))},t.el.addEventListener("mousemove",t._mouseMove,!0),t.el.addEventListener("touchstart",t._mouseMove,!0),t.el.addEventListener("touchmove",t._mouseMove,!0)},disableMouseControls:function(){t._mouseMove&&(t.el.removeEventListener("mousemove",t._mouseMove,!0),t.el.style.cursor="inherit",t._mouseMove=null)},drawButtons:function(){var i=t.input.keypad,e=t.ctx;e.save(),e.textAlign="center",e.textBaseline="middle";for(var s=0;s<i.controls.length;s++){var n=i.controls[s];if(n[0]){e.font="bold "+i.size/2+"px arial";var o=s*i.unit+i.gutter,r=i.bottom-i.unit,a=t.inputs[n[0]];e.fillStyle=i.color||"#FFFFFF",e.globalAlpha=a?1:.5,e.fillRect(o,r,i.size,i.size),e.fillStyle=i.text||"#000000",e.fillText(n[1],o+i.size/2,r+i.size/2)}}e.restore()},drawCircle:function(i,e,s,n){var o=t.ctx,r=t.joypad;o.save(),o.beginPath(),o.globalAlpha=r.alpha,o.fillStyle=s,o.arc(i,e,n,0,2*Math.PI,!0),o.closePath(),o.fill(),o.restore()},drawJoypad:function(){var i=t.joypad;null!==i.joypadTouch&&(t.input.drawCircle(i.centerX,i.centerY,i.background,i.size),null!==i.x&&t.input.drawCircle(i.x,i.y,i.color,i.center))},drawCanvas:function(){this.touchEnabled&&this.drawButtons(),this.joypadEnabled&&this.drawJoypad()}}),t.input=new t.InputSystem,t.controls=function(i){return t.input.keyboardControls(),i?(t.input.touchControls({controls:[[],[],[],["action","b"],["fire","a"]]}),t.input.joypadControls()):t.input.touchControls(),t},t.component("platformerControls",{defaults:{speed:200,jumpSpeed:-300,collisions:[]},added:function(){var i=this.entity.p;t._defaults(i,this.defaults),this.entity.on("step",this,"step"),this.entity.on("bump.bottom",this,"landed"),i.landed=0,i.direction="right"},landed:function(){var i=this.entity.p;i.landed=.2},step:function(i){var e=this.entity.p;if(void 0===e.ignoreControls||!e.ignoreControls){var s=null;if(void 0!==e.collisions&&e.collisions.length>0&&(t.inputs.left||t.inputs.right||e.landed>0)){if(1===e.collisions.length)s=e.collisions[0];else{s=null;for(var n=0;n<e.collisions.length;n++)e.collisions[n].normalY<0&&(s=e.collisions[n])}null!==s&&s.normalY>-.3&&s.normalY<.3&&(s=null)}t.inputs.left?(e.direction="left",s&&e.landed>0?(e.vx=e.speed*s.normalY,e.vy=-e.speed*s.normalX):e.vx=-e.speed):t.inputs.right?(e.direction="right",s&&e.landed>0?(e.vx=-e.speed*s.normalY,e.vy=e.speed*s.normalX):e.vx=e.speed):(e.vx=0,s&&e.landed>0&&(e.vy=0)),e.landed>0&&(t.inputs.up||t.inputs.action)&&!e.jumping?(e.vy=e.jumpSpeed,e.landed=-i,e.jumping=!0):(t.inputs.up||t.inputs.action)&&(e.jumping=!0),!e.jumping||t.inputs.up||t.inputs.action||(e.jumping=!1,e.vy<e.jumpSpeed/3&&(e.vy=e.jumpSpeed/3))}e.landed-=i}}),t.component("stepControls",{added:function(){var t=this.entity.p;t.stepDistance||(t.stepDistance=32),t.stepDelay||(t.stepDelay=.2),t.stepWait=0,this.entity.on("step",this,"step"),this.entity.on("hit",this,"collision")},collision:function(){var i=this.entity.p;i.stepping&&(i.stepping=!1,i.x=i.origX,i.y=i.origY)},step:function(i){var e=this.entity.p;e.stepWait-=i,e.stepping&&(e.x+=e.diffX*i/e.stepDelay,e.y+=e.diffY*i/e.stepDelay),e.stepWait>0||(e.stepping&&(e.x=e.destX,e.y=e.destY),e.stepping=!1,e.diffX=0,e.diffY=0,t.inputs.left?e.diffX=-e.stepDistance:t.inputs.right&&(e.diffX=e.stepDistance),t.inputs.up?e.diffY=-e.stepDistance:t.inputs.down&&(e.diffY=e.stepDistance),(e.diffY||e.diffX)&&(e.stepping=!0,e.origX=e.x,e.origY=e.y,e.destX=e.x+e.diffX,e.destY=e.y+e.diffY,e.stepWait=e.stepDelay))}})},Quintus.Scenes=function(t){t.scenes={},t.stages=[],t.Class.extend("Scene",{init:function(t,i){this.opts=i||{},this.sceneFunc=t}}),t.scene=function(i,e,s){return void 0===e?t.scenes[i]:(t._isFunction(e)&&(e=new t.Scene(e,s),e.name=i),t.scenes[i]=e,e)},t._nullContainer={c:{x:0,y:0,angle:0,scale:1},matrix:t.matrix2d()},t.collision=function(){function r(t,s){var n=t[s],o=t[s+1]||t[0];i=-(o[1]-n[1]),e=o[0]-n[0];var r=Math.sqrt(i*i+e*e);r>0&&(i/=r,e/=r)}function a(t){return i*t[0]+e*t[1]}function h(t,h,l){var c,u,f,p,d,g,m,v,y,x,w,b,S,E,_=Number.POSITIVE_INFINITY,T=!1,C=l?o:n;for(s[0]=0,s[1]=0,t.c?S=t.c.points:(S=t.p.points,s[0]+=t.p.x,s[1]+=t.p.y),h.c?E=h.c.points:(E=h.p.points,s[0]+=-h.p.x,s[1]+=-h.p.y),t=t.p,h=h.p,y=0;y<S.length;y++){for(r(S,y),c=a(S[0]),u=c,x=1;x<S.length;x++)v=a(S[x]),c>v&&(c=v),v>u&&(u=v);for(f=a(E[0]),p=f,x=1;x<E.length;x++)v=a(E[x]),f>v&&(f=v),v>p&&(p=v);if(m=a(s),c+=m,u+=m,d=c-p,g=f-u,d>0||g>0)return null;w=-1*(p-c),l&&(w*=-1),b=Math.abs(w),_>b&&(C.distance=w,C.magnitude=b,C.normalX=i,C.normalY=e,C.distance>0&&(C.distance*=-1,C.normalX*=-1,C.normalY*=-1),T=!0,_=b)}return T?C:null}function l(i,e){var s,n,o;return i.p.points||t._generatePoints(i),e.p.points||t._generatePoints(e),(s=h(i,e))&&(n=h(e,i,!0))?(o=n.magnitude<s.magnitude?n:s,0===o.magnitude?!1:(o.separate[0]=o.distance*o.normalX,o.separate[1]=o.distance*o.normalY,o)):!1}var i,e,s=[0,0],n={separate:[]},o={separate:[]};return l}(),t.overlap=function(t,i){var e=t.c||t.p||t,s=i.c||i.p||i,n=e.x-(e.cx||0),o=e.y-(e.cy||0),r=s.x-(s.cx||0),a=s.y-(s.cy||0);return!(o+e.h<a||o>a+s.h||n+e.w<r||n>r+s.w)},t.Stage=t.GameObject.extend({defaults:{sort:!1,gridW:400,gridH:400,x:0,y:0},init:function(i,e){this.scene=i,this.items=[],this.lists={},this.index={},this.removeList=[],this.grid={},this._collisionLayers=[],this.time=0,this.defaults.w=t.width,this.defaults.h=t.height,this.options=t._extend({},this.defaults),this.scene&&t._extend(this.options,i.opts),e&&t._extend(this.options,e),this.options.sort&&!t._isFunction(this.options.sort)&&(this.options.sort=function(t,i){return(t.p&&t.p.z||-1)-(i.p&&i.p.z||-1)})},destroyed:function(){this.invoke("debind"),this.trigger("destroyed")},loadScene:function(){this.scene&&this.scene.sceneFunc(this)},loadAssets:function(i){for(var e=t._isArray(i)?i:t.asset(i),s=0;s<e.length;s++){var n=e[s][0],o=e[s][1];this.insert(new t[n](o))}},each:function(t){for(var i=0,e=this.items.length;e>i;i++)t.call(this.items[i],arguments[1],arguments[2])},invoke:function(t){for(var i=0,e=this.items.length;e>i;i++)this.items[i][t].call(this.items[i],arguments[1],arguments[2])},detect:function(t){for(var i=this.items.length-1;i>=0;i--)if(t.call(this.items[i],arguments[1],arguments[2],arguments[3]))return this.items[i];return!1},identify:function(t){for(var i,e=this.items.length-1;e>=0;e--)if(i=t.call(this.items[e],arguments[1],arguments[2],arguments[3]))return i;return!1},addToLists:function(t,i){for(var e=0;e<t.length;e++)this.addToList(t[e],i)},addToList:function(t,i){this.lists[t]||(this.lists[t]=[]),this.lists[t].push(i)},removeFromLists:function(t,i){for(var e=0;e<t.length;e++)this.removeFromList(t[e],i)},removeFromList:function(t,i){var e=this.lists[t].indexOf(i);-1!==e&&this.lists[t].splice(e,1)},insert:function(i,e){return this.items.push(i),i.stage=this,i.container=e,e&&e.children.push(i),i.grid={},t._generatePoints(i),t._generateCollisionPoints(i),i.className&&this.addToList(i.className,i),i.activeComponents&&this.addToLists(i.activeComponents,i),i.p&&(this.index[i.p.id]=i),this.trigger("inserted",i),i.trigger("inserted",this),this.regrid(i),i},remove:function(t){this.delGrid(t),this.removeList.push(t)},forceRemove:function(t){var i=this.items.indexOf(t);if(-1!==i){if(this.items.splice(i,1),t.className&&this.removeFromList(t.className,t),t.activeComponents&&this.removeFromLists(t.activeComponents,t),t.container){var e=t.container.children.indexOf(t);-1!==e&&t.container.children.splice(e,1)}t.destroy&&t.destroy(),t.p.id&&delete this.index[t.p.id],this.trigger("removed",t)}},pause:function(){this.paused=!0},unpause:function(){this.paused=!1},_gridCellCheck:function(i,e,s,n){if(t._isUndefined(n)||n&i){var o=this.index[e];if(o&&o!==s&&t.overlap(s,o)){var r=t.collision(s,o);return r?(r.obj=o,r):!1}}},gridTest:function(i,e){for(var n,o,s=i.grid,r=s.Y1;r<=s.Y2;r++)if(this.grid[r])for(var a=s.X1;a<=s.X2;a++)if(n=this.grid[r][a],n&&(o=t._detect(n,this._gridCellCheck,this,i,e)))return o;return!1},collisionLayer:function(t){return this._collisionLayers.push(t),t.collisionLayer=!0,this.insert(t)},_collideCollisionLayer:function(t,i){for(var e,s=0,n=this._collisionLayers.length;n>s;s++){var o=this._collisionLayers[s];if(o.p.type&i&&(e=o.collide(t)))return e.obj=o,e}return!1},search:function(i,e){var s;return i.grid||this.regrid(i,i.stage!==this),e=t._isUndefined(e)?i.p&&i.p.collisionMask:e,s=this._collideCollisionLayer(i,e),s=s||this.gridTest(i,e)},_locateObj:{p:{x:0,y:0,cx:0,cy:0,w:1,h:1},grid:{}},locate:function(t,i,e){var s=null;return this._locateObj.p.x=t,this._locateObj.p.y=i,this.regrid(this._locateObj,!0),s=this._collideCollisionLayer(this._locateObj,e),s=s||this.gridTest(this._locateObj,e),s&&s.obj?s.obj:!1},collide:function(i,e){var s,n,o,r,a,h;for(t._isObject(e)?(o=e.collisionMask,r=e.maxCol,h=e.skipEvents):o=e,o=t._isUndefined(o)?i.p&&i.p.collisionMask:o,r=r||3,t._generateCollisionPoints(i),this.regrid(i),a=r;a>0&&(s=this._collideCollisionLayer(i,o));)h||(i.trigger("hit",s),i.trigger("hit.collision",s)),t._generateCollisionPoints(i),this.regrid(i),a--;for(a=r;a>0&&(n=this.gridTest(i,o));){if(i.trigger("hit",n),i.trigger("hit.sprite",n),!h){var l=n.obj;n.obj=i,n.normalX*=-1,n.normalY*=-1,n.distance=0,n.magnitude=0,n.separate[0]=0,n.separate[1]=0,l.trigger("hit",n),l.trigger("hit.sprite",n)}t._generateCollisionPoints(i),this.regrid(i),a--}return n||s},delGrid:function(t){for(var i=t.grid,e=i.Y1;e<=i.Y2;e++)if(this.grid[e])for(var s=i.X1;s<=i.X2;s++)this.grid[e][s]&&delete this.grid[e][s][t.p.id]},addGrid:function(t){for(var i=t.grid,e=i.Y1;e<=i.Y2;e++){this.grid[e]||(this.grid[e]={});for(var s=i.X1;s<=i.X2;s++)this.grid[e][s]||(this.grid[e][s]={}),this.grid[e][s][t.p.id]=t.p.type}},regrid:function(t,i){if(!t.collisionLayer){t.grid=t.grid||{};var e=t.c||t.p,s=Math.floor((e.x-e.cx)/this.options.gridW),n=Math.floor((e.y-e.cy)/this.options.gridH),o=Math.floor((e.x-e.cx+e.w)/this.options.gridW),r=Math.floor((e.y-e.cy+e.h)/this.options.gridH),a=t.grid;(a.X1!==s||a.X2!==o||a.Y1!==n||a.Y2!==r)&&(void 0!==a.X1&&this.delGrid(t),a.X1=s,a.X2=o,a.Y1=n,a.Y2=r,i||this.addGrid(t))}},markSprites:function(i,e){for(var p,d,s=this.viewport,n=s?s.scale:1,o=s?s.x:0,r=s?s.y:0,a=t.width/n,h=t.height/n,l=Math.floor(o/this.options.gridW),c=Math.floor(r/this.options.gridH),u=Math.floor((o+a)/this.options.gridW),f=Math.floor((r+h)/this.options.gridH),g=c;f>=g;g++)if(p=this.grid[g])for(var m=l;u>=m;m++)if(d=p[m])for(var v in d)this.index[v]&&(this.index[v].mark=e,this.index[v].container&&(this.index[v].container.mark=e))},updateSprites:function(i,e,s){for(var n,o=0,r=i.length;r>o;o++)n=i[o],(s||!n.p.visibleOnly||n.mark&&!(n.mark<this.time))&&(s||!n.container)&&(n.update(e),t._generateCollisionPoints(n),this.regrid(n))},step:function(t){if(this.paused)return!1;if(this.time+=t,this.markSprites(this.items,this.time),this.trigger("prestep",t),this.updateSprites(this.items,t),this.trigger("step",t),this.removeList.length>0){for(var i=0,e=this.removeList.length;e>i;i++)this.forceRemove(this.removeList[i]);this.removeList.length=0}this.trigger("poststep",t)},hide:function(){this.hidden=!0},show:function(){this.hidden=!1},stop:function(){this.hide(),this.pause()},start:function(){this.show(),this.unpause()},render:function(t){if(this.hidden)return!1;this.options.sort&&this.items.sort(this.options.sort),this.trigger("prerender",t),this.trigger("beforerender",t);for(var i=0,e=this.items.length;e>i;i++){var s=this.items[i];!s.container&&(s.p.renderAlways||s.mark>=this.time)&&s.render(t)}this.trigger("render",t),this.trigger("postrender",t)}}),t.activeStage=0,t.StageSelector=t.Class.extend({emptyList:[],init:function(t,i){this.stage=t,this.selector=i,this.items=this.stage.lists[this.selector]||this.emptyList,this.length=this.items.length},each:function(t){for(var i=0,e=this.items.length;e>i;i++)t.call(this.items[i],arguments[1],arguments[2]);return this},invoke:function(t){for(var i=0,e=this.items.length;e>i;i++)this.items[i][t].call(this.items[i],arguments[1],arguments[2]);return this},trigger:function(t,i){this.invoke("trigger",t,i)},destroy:function(){this.invoke("destroy")},detect:function(t){for(var i=0,s=this.items.length;s>i;i++)if(t.call(this.items[i],arguments[1],arguments[2]))return this.items[i];return!1},identify:function(t){for(var i=null,e=0,n=this.items.length;n>e;e++)if(i=t.call(this.items[e],arguments[1],arguments[2]))return i;return!1},_pObject:function(i){t._extend(this.p,i)},_pSingle:function(t,i){this.p[t]=i},set:function(t,i){return void 0===i?this.each(this._pObject,t):this.each(this._pSingle,t,i),this},at:function(t){return this.items[t]},first:function(){return this.items[0]},last:function(){return this.items[this.items.length-1]}}),t.select=function(i,e){return e=void 0===e?t.activeStage:e,e=t.stage(e),t._isNumber(i)?e.index[i]:new t.StageSelector(e,i)},t.stage=function(i){return i=void 0===i?t.activeStage:i,t.stages[i]},t.stageScene=function(i,e,s){t._isString(i)&&(i=t.scene(i)),t._isObject(e)&&(s=e,e=t._popProperty(s,"stage")||i&&i.opts.stage||0),s=t._clone(s);var n=t._popProperty(s,"stageClass")||i&&i.opts.stageClass||t.Stage;e=t._isUndefined(e)?i&&i.opts.stage||0:e,t.stages[e]&&t.stages[e].destroy(),t.activeStage=e;var o=t.stages[e]=new n(i,s);return o.options.asset&&o.loadAssets(o.options.asset),i&&o.loadScene(),t.activeStage=0,t.loop||t.gameLoop(t.stageGameLoop),o},t.stageGameLoop=function(i){var e,s,n;for(0>i&&(i=1/60),i>1/15&&(i=1/15),e=0,s=t.stages.length;s>e;e++)t.activeStage=e,n=t.stage(),n&&n.step(i);for(t.ctx&&t.clear(),e=0,s=t.stages.length;s>e;e++)t.activeStage=e,n=t.stage(),n&&n.render(t.ctx);t.activeStage=0,t.input&&t.ctx&&t.input.drawCanvas(t.ctx)},t.clearStage=function(i){t.stages[i]&&(t.stages[i].destroy(),t.stages[i]=null)},t.clearStages=function(){for(var i=0,e=t.stages.length;e>i;i++)t.stages[i]&&t.stages[i].destroy();t.stages.length=0}},Quintus.Sprites=function(t){return t.Class.extend("SpriteSheet",{init:function(i,e,s){if(!t.asset(e))throw"Invalid Asset:"+e;t._extend(this,{name:i,asset:e,w:t.asset(e).width,h:t.asset(e).height,tileW:64,tileH:64,sx:0,sy:0,spacingX:0,spacingY:0,frameProperties:{}}),s&&t._extend(this,s),this.tilew&&(this.tileW=this.tilew,delete this.tilew),this.tileh&&(this.tileH=this.tileh,delete this.tileh),this.cols=this.cols||Math.floor(this.w/(this.tileW+this.spacingX)),this.frames=this.cols*Math.ceil(this.h/(this.tileH+this.spacingY))},fx:function(t){return Math.floor(t%this.cols*(this.tileW+this.spacingX)+this.sx)},fy:function(t){return Math.floor(Math.floor(t/this.cols)*(this.tileH+this.spacingY)+this.sy)},draw:function(i,e,s,n){i||(i=t.ctx),i.drawImage(t.asset(this.asset),this.fx(n),this.fy(n),this.tileW,this.tileH,Math.floor(e),Math.floor(s),this.tileW,this.tileH)}}),t.sheets={},t.sheet=function(i,e,s){return e?void(t.sheets[i]=new t.SpriteSheet(i,e,s)):t.sheets[i]},t.compileSheets=function(i,e){var s=t.asset(e);t._each(s,function(e,s){t.sheet(s,i,e)})},t.SPRITE_NONE=0,t.SPRITE_DEFAULT=1,t.SPRITE_PARTICLE=2,t.SPRITE_ACTIVE=4,t.SPRITE_FRIENDLY=8,t.SPRITE_ENEMY=16,t.SPRITE_POWERUP=32,t.SPRITE_UI=64,t.SPRITE_ALL=65535,t._generatePoints=function(t,i){if(!t.p.points||i){var e=t.p,s=e.w/2,n=e.h/2;e.points=[[-s,-n],[s,-n],[s,n],[-s,n]]}},t._generateCollisionPoints=function(i){if(i.matrix||i.refreshMatrix){i.c||(i.c={points:[]});var e=i.p,s=i.c;if(e.moved||s.origX!==e.x||s.origY!==e.y||s.origScale!==e.scale||s.origScale!==e.angle){s.origX=e.x,s.origY=e.y,s.origScale=e.scale,s.origAngle=e.angle,i.refreshMatrix();var n;if(!(i.container||e.scale&&1!==e.scale||0!==e.angle)){for(n=0;n<i.p.points.length;n++)i.c.points[n]=i.c.points[n]||[],i.c.points[n][0]=e.x+i.p.points[n][0],i.c.points[n][1]=e.y+i.p.points[n][1];return s.x=e.x,s.y=e.y,s.cx=e.cx,s.cy=e.cy,s.w=e.w,void(s.h=e.h)}var o=i.container||t._nullContainer;s.x=o.matrix.transformX(e.x,e.y),s.y=o.matrix.transformY(e.x,e.y),s.angle=e.angle+o.c.angle,s.scale=(o.c.scale||1)*(e.scale||1);var r=1/0,a=1/0,h=-1/0,l=-1/0;for(n=0;n<i.p.points.length;n++){i.c.points[n]||(i.c.points[n]=[]),i.matrix.transformArr(i.p.points[n],i.c.points[n]);var c=i.c.points[n][0],u=i.c.points[n][1];r>c&&(r=c),c>h&&(h=c),a>u&&(a=u),u>l&&(l=u)}r===h&&(h+=1),a===l&&(l+=1),s.cx=s.x-r,s.cy=s.y-a,s.w=h-r,s.h=l-a}}},t.GameObject.extend("Sprite",{init:function(i,e){this.p=t._extend({x:0,y:0,z:0,opacity:1,angle:0,frame:0,type:t.SPRITE_DEFAULT|t.SPRITE_ACTIVE,name:"",spriteProperties:{}},e),this.matrix=new t.Matrix2D,this.children=[],t._extend(this.p,i),this.size(),this.p.id=this.p.id||t._uniqueId(),this.refreshMatrix()},size:function(t){!t&&this.p.w&&this.p.h||(this.asset()?(this.p.w=this.asset().width,this.p.h=this.asset().height):this.sheet()&&(this.p.w=this.sheet().tileW,this.p.h=this.sheet().tileH)),this.p.cx=t||void 0===this.p.cx?this.p.w/2:this.p.cx,this.p.cy=t||void 0===this.p.cy?this.p.h/2:this.p.cy},asset:function(i,e){return i?(this.p.asset=i,void(e&&(this.size(!0),t._generatePoints(this,!0)))):t.asset(this.p.asset)},sheet:function(i,e){return i?(this.p.sheet=i,void(e&&(this.size(!0),t._generatePoints(this,!0)))):t.sheet(this.p.sheet)},hide:function(){this.p.hidden=!0},show:function(){this.p.hidden=!1},set:function(i){return t._extend(this.p,i),this},_sortChild:function(t,i){return(t.p&&t.p.z||-1)-(i.p&&i.p.z||-1)},_flipArgs:{x:[-1,1],y:[1,-1],xy:[-1,-1]},render:function(i){var e=this.p;e.hidden||(i||(i=t.ctx),this.trigger("predraw",i),i.save(),void 0!==this.p.opacity&&1!==this.p.opacity&&(i.globalAlpha=this.p.opacity),this.matrix.setContextTransform(i),this.p.flip&&i.scale.apply(i,this._flipArgs[this.p.flip]),this.trigger("beforedraw",i),this.draw(i),this.trigger("draw",i),i.restore(),this.p.sort&&this.children.sort(this._sortChild),t._invoke(this.children,"render",i),this.trigger("postdraw",i),t.debug&&this.debugRender(i))},center:function(){this.container?(this.p.x=this.container.p.w/2,this.p.y=this.container.p.h/2):(this.p.x=t.width/2,this.p.y=t.height/2)},draw:function(i){var e=this.p;e.sheet?this.sheet().draw(i,-e.cx,-e.cy,e.frame):e.asset?i.drawImage(t.asset(e.asset),-e.cx,-e.cy):e.color&&(i.fillStyle=e.color,i.fillRect(-e.cx,-e.cy,e.w,e.h))},debugRender:function(i){this.p.points||t._generatePoints(this),i.save(),this.matrix.setContextTransform(i),i.beginPath(),i.fillStyle=this.p.hit?"blue":"red",i.strokeStyle="#FF0000",i.fillStyle="rgba(0,0,0,0.5)",i.moveTo(this.p.points[0][0],this.p.points[0][1]);for(var e=0;e<this.p.points.length;e++)i.lineTo(this.p.points[e][0],this.p.points[e][1]);if(i.lineTo(this.p.points[0][0],this.p.points[0][1]),i.stroke(),t.debugFill&&i.fill(),i.restore(),this.c){var s=this.c;i.save(),i.globalAlpha=1,i.lineWidth=2,i.strokeStyle="#FF00FF",i.beginPath(),i.moveTo(s.x-s.cx,s.y-s.cy),i.lineTo(s.x-s.cx+s.w,s.y-s.cy),i.lineTo(s.x-s.cx+s.w,s.y-s.cy+s.h),i.lineTo(s.x-s.cx,s.y-s.cy+s.h),i.lineTo(s.x-s.cx,s.y-s.cy),i.stroke(),i.restore()}},update:function(t){this.trigger("prestep",t),this.step&&this.step(t),this.trigger("step",t),this.refreshMatrix(),this.stage&&this.children.length>0&&this.stage.updateSprites(this.children,t,!0),this.p.collisions&&(this.p.collisions=[])},refreshMatrix:function(){var t=this.p;this.matrix.identity(),this.container&&this.matrix.multiply(this.container.matrix),this.matrix.translate(t.x,t.y),t.scale&&this.matrix.scale(t.scale,t.scale),this.matrix.rotateDeg(t.angle)}}),t.Sprite.extend("MovingSprite",{init:function(i,e){this._super(t._extend({vx:0,vy:0,ax:0,ay:0},i),e)},step:function(t){var i=this.p;i.vx+=i.ax*t,i.vy+=i.ay*t,i.x+=i.vx*t,i.y+=i.vy*t}}),t},Quintus.TMX=function(t){function i(t,i){var e=t.getAttribute(i);return isNaN(e)?e:+e}function e(t){for(var e=t.querySelectorAll("property"),s={},n=0;n<e.length;n++){var o=e[n];s[i(o,"name")]=i(o,"value")}return s}t.assetTypes.tmx="TMX",t.loadAssetTMX=function(i,e,s,n){t.loadAssetOther(i,e,function(t,i){var e=new DOMParser,n=e.parseFromString(i,"application/xml");s(t,n)},n)},t._tmxExtractAssetName=function(t){var i=t.getAttribute("source"),e=i.split("/");return e[e.length-1]},t._tmxExtractSources=function(i){var e=i.querySelectorAll("[source]");return t._map(e,t._tmxExtractAssetName)},t.loadTMX=function(i,e,s){t._isString(i)&&(i=t._normalizeArg(i));var n=[];t._each(i,function(i){"tmx"===t._fileExtension(i)&&n.push(i)});var o=[];t.load(i,function(){t._each(n,function(i){var e=t._tmxExtractSources(t.asset(i));o=o.concat(e)}),o.length>0?t.load(o,e,s):e()})},t._tmxLoadTilesets=function(s,n){function r(t){var i=t.split(",");return[parseFloat(i[0]),parseFloat(i[1])]}for(var o=[],a=0;a<s.length;a++){for(var h=s[a],l=i(h,"name"),c=i(h,"firstgid"),u=t._tmxExtractAssetName(h.querySelector("image")),f={},p={tileW:i(h,"tilewidth"),tileH:i(h,"tileheight"),spacingX:i(h,"spacing"),spacingY:i(h,"spacing")},d=h.querySelectorAll("tile"),g=0;g<d.length;g++){var m=d[g],v=i(m,"id"),y=c+v,x=e(m);x.points&&(x.points=t._map(x.points.split(" "),r)),n[y]=x,f[v]=x}p.frameProperties=f,o.push([c,l]),t.sheet(l,u,p)}return o},t._tmxProcessImageLayer=function(i,s,n,o){var r=t._tmxExtractAssetName(o.querySelector("image")),a=e(o);a.asset=r,i.insert(new t.Repeater(a))},t._lookupGid=function(t,i){for(var e=0;i[e+1]&&t>=i[e+1][0];)e++;return i[e]},t._tmxProcessTileLayer=function(s,n,o,r){for(var c,u,f,a=r.querySelectorAll("tile"),h=i(r,"width"),l=i(r,"height"),p=[],d=0,g=0;l>g;g++){p[g]=[];for(var m=0;h>m;m++){var v=i(a[d],"gid");0===v?p[g].push(null):(u||(c=t._lookupGid(i(a[d],"gid"),n),u=c[0],f=c[1]),p[g].push(v-u)),d++}}var y=t._extend({tileW:t.sheet(f).tileW,tileH:t.sheet(f).tileH,sheet:f,tiles:p},e(r)),x=y.Class||"TileLayer";y.collision?s.collisionLayer(new t[x](y)):s.insert(new t[x](y))},t._tmxProcessObjectLayer=function(s,n,o,r){for(var a=r.querySelectorAll("object"),h=0;h<a.length;h++){var l=a[h],c=i(l,"gid"),u=i(l,"x"),f=i(l,"y"),p=o[c],d=e(l);if(!p)throw"Invalid TMX Object: missing properties for GID:"+c;if(!p.Class)throw"Invalid TMX Object: missing Class for GID:"+c;var g=p.Class;if(!g)throw"Invalid TMX Object Class: "+g+" GID:"+c;var m=t._extend(t._extend({x:u,y:f},p),d),v=new t[g](m);v.p.x+=v.p.w/2,v.p.y-=v.p.h/2,s.insert(v)}},t._tmxProcessors={objectgroup:t._tmxProcessObjectLayer,layer:t._tmxProcessTileLayer,imagelayer:t._tmxProcessImageLayer},t.stageTMX=function(i,e){var s=t._isString(i)?t.asset(i):i,n={},o=s.getElementsByTagName("tileset"),r=t._tmxLoadTilesets(o,n);t._each(s.documentElement.childNodes,function(i){var s=i.tagName;t._tmxProcessors[s]&&t._tmxProcessors[s](e,r,n,i)})}},Quintus.Touch=function(t){if(t._isUndefined(Quintus.Sprites))throw"Quintus.Touch requires Quintus.Sprites Module";var e=[0],s=0;t.Evented.extend("TouchSystem",{init:function(){var i=this;this.boundTouch=function(t){i.touch(t)},this.boundDrag=function(t){i.drag(t)},this.boundEnd=function(t){i.touchEnd(t)},t.el.addEventListener("touchstart",this.boundTouch),t.el.addEventListener("mousedown",this.boundTouch),t.el.addEventListener("touchmove",this.boundDrag),t.el.addEventListener("mousemove",this.boundDrag),t.el.addEventListener("touchend",this.boundEnd),t.el.addEventListener("mouseup",this.boundEnd),t.el.addEventListener("touchcancel",this.boundEnd),this.touchPos=new t.Evented,this.touchPos.grid={},this.touchPos.p={w:1,h:1,cx:0,cy:0},this.activeTouches={},this.touchedObjects={}},destroy:function(){t.el.removeEventListener("touchstart",this.boundTouch),t.el.removeEventListener("mousedown",this.boundTouch),t.el.removeEventListener("touchmove",this.boundDrag),t.el.removeEventListener("mousemove",this.boundDrag),t.el.removeEventListener("touchend",this.boundEnd),t.el.removeEventListener("mouseup",this.boundEnd),t.el.removeEventListener("touchcancel",this.boundEnd)},normalizeTouch:function(i,e){var s=i.offsetX,n=i.offsetY;if((t._isUndefined(s)||t._isUndefined(n))&&(s=i.layerX,n=i.layerY),t._isUndefined(s)||t._isUndefined(n)){if(void 0===t.touch.offsetX){t.touch.offsetX=0,t.touch.offsetY=0;var o=t.el;do t.touch.offsetX+=o.offsetLeft,t.touch.offsetY+=o.offsetTop;while(o=o.offsetParent)}s=i.pageX-t.touch.offsetX,n=i.pageY-t.touch.offsetY}return this.touchPos.p.ox=this.touchPos.p.px=s/t.cssWidth*t.width,this.touchPos.p.oy=this.touchPos.p.py=n/t.cssHeight*t.height,e.viewport&&(this.touchPos.p.px/=e.viewport.scale,this.touchPos.p.py/=e.viewport.scale,this.touchPos.p.px+=e.viewport.x,this.touchPos.p.py+=e.viewport.y),this.touchPos.p.x=this.touchPos.p.px,this.touchPos.p.y=this.touchPos.p.py,this.touchPos.obj=null,this.touchPos},touch:function(i){for(var n=i.changedTouches||[i],o=0;o<n.length;o++)for(var r=0;r<e.length;r++){var a=n[o],h=t.stage(e[r]);if(h){a.identifier=a.identifier||0;var l=this.normalizeTouch(a,h);h.regrid(l,!0);var u,c=h.search(l,s);if((c||r===e.length-1)&&(u=c&&c.obj,l.obj=u,this.trigger("touch",l)),u&&!this.touchedObjects[u]){this.activeTouches[a.identifier]={x:l.p.px,y:l.p.py,origX:u.p.x,origY:u.p.y,sx:l.p.ox,sy:l.p.oy,identifier:a.identifier,obj:u,stage:h},this.touchedObjects[u.p.id]=!0,u.trigger("touch",this.activeTouches[a.identifier]);break}}}},drag:function(t){for(var i=t.changedTouches||[t],e=0;e<i.length;e++){var s=i[e];s.identifier=s.identifier||0;var n=this.activeTouches[s.identifier],o=n&&n.stage;if(n){var r=this.normalizeTouch(s,o);n.x=r.p.px,n.y=r.p.py,n.dx=r.p.ox-n.sx,n.dy=r.p.oy-n.sy,n.obj.trigger("drag",n)}}t.preventDefault()},touchEnd:function(t){for(var i=t.changedTouches||[t],e=0;e<i.length;e++){var s=i[e];s.identifier=s.identifier||0;var n=this.activeTouches[s.identifier];n&&(n.obj.trigger("touchEnd",n),delete this.touchedObjects[n.obj.p.id],this.activeTouches[s.identifier]=null)}t.preventDefault()}}),t.touch=function(i,n){return t.untouch(),s=i||t.SPRITE_UI,e=n||[2,1,0],t._isArray(e)||(e=[e]),t._touch||(t.touchInput=new t.TouchSystem),t},t.untouch=function(){return t.touchInput&&(t.touchInput.destroy(),delete t.touchInput),t}},Quintus.UI=function(t){if(t._isUndefined(Quintus.Touch))throw"Quintus.UI requires Quintus.Touch Module";t.UI={},t.UI.roundRect=function(t,i){t.beginPath(),t.moveTo(-i.cx+i.radius,-i.cy),t.lineTo(-i.cx+i.w-i.radius,-i.cy),t.quadraticCurveTo(-i.cx+i.w,-i.cy,-i.cx+i.w,-i.cy+i.radius),t.lineTo(-i.cx+i.w,-i.cy+i.h-i.radius),t.quadraticCurveTo(-i.cx+i.w,-i.cy+i.h,-i.cx+i.w-i.radius,-i.cy+i.h),t.lineTo(-i.cx+i.radius,-i.cy+i.h),t.quadraticCurveTo(-i.cx,-i.cy+i.h,-i.cx,-i.cy+i.h-i.radius),t.lineTo(-i.cx,-i.cy+i.radius),t.quadraticCurveTo(-i.cx,-i.cy,-i.cx+i.radius,-i.cy),t.closePath()},t.UI.Container=t.Sprite.extend("UI.Container",{init:function(i,e){var n,s=t._clone(i||{});i&&t._isString(i.w)&&(n=i.w.match(/^[0-9]+%$/))&&(s.w=parseInt(i.w,10)*t.width/100,s.x=t.width/2-s.w/2),i&&t._isString(i.h)&&(n=i.h.match(/^[0-9]+%$/))&&(s.h=parseInt(i.h,10)*t.height/100,s.y=t.height/2-s.h/2),this._super(t._defaults(s,e),{opacity:1,hidden:!1,fill:null,highlight:null,radius:5,stroke:"#000",border:!1,shadow:!1,shadowColor:!1,outlineWidth:!1,outlineColor:"#000",type:t.SPRITE_NONE})},insert:function(t){return this.stage.insert(t,this),t},fit:function(t,i){if(0!==this.children.length){void 0===t&&(t=0),void 0===i&&(i=t);for(var e=1/0,s=1/0,n=-1/0,o=-1/0,r=0;r<this.children.length;r++){var a=this.children[r],h=a.p.x-a.p.cx,l=a.p.y-a.p.cy,c=a.p.x-a.p.cx+a.p.w,u=a.p.y-a.p.cy+a.p.h;e>h&&(e=h),s>l&&(s=l),c>n&&(n=c),u>o&&(o=u)}this.p.cx=-e+i,this.p.cy=-s+t,this.p.w=n-e+2*i,this.p.h=o-s+2*t}},addShadow:function(i){if(this.p.shadow){var e=t._isNumber(this.p.shadow)?this.p.shadow:5;i.shadowOffsetX=e,i.shadowOffsetY=e,i.shadowColor=this.p.shadowColor||"rgba(0,0,50,0.1)"}},clearShadow:function(t){t.shadowColor="transparent"},drawRadius:function(i){t.UI.roundRect(i,this.p),this.addShadow(i),i.fill(),this.p.border&&(this.clearShadow(i),i.lineWidth=this.p.border,i.stroke())},drawSquare:function(t){this.addShadow(t),this.p.fill&&t.fillRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h),this.p.border&&(this.clearShadow(t),t.lineWidth=this.p.border,t.strokeRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h))},draw:function(t){return this.p.hidden?!1:void((this.p.border||this.p.fill)&&(t.globalAlpha=this.p.opacity,t.fillStyle=1===this.p.frame&&this.p.highlight?this.p.highlight:this.p.fill,t.strokeStyle=this.p.stroke,this.p.radius>0?this.drawRadius(t):this.drawSquare(t)))}}),t.UI.Text=t.Sprite.extend("UI.Text",{init:function(i,e){this._super(t._defaults(i||{},e),{type:t.SPRITE_UI,size:24}),this.p.label&&this.calcSize()},calcSize:function(){this.setFont(t.ctx),this.splitLabel=this.p.label.split("\n");for(var i="",e=0;e<this.splitLabel.length;e++)this.splitLabel[e].length>i.length&&(i=this.splitLabel[e]);var s=t.ctx.measureText(i);this.p.h=(this.p.size||24)*this.splitLabel.length*1.2,this.p.w=s.width,this.p.cx=this.p.w/2,this.p.cy=this.p.h/2},prerender:function(){this.p.oldLabel!==this.p.label&&(this.p.oldLabel=this.p.label,this.calcSize(),this.el.width=this.p.w,this.el.height=4*this.p.h,this.ctx.clearRect(0,0,this.p.w,this.p.h),this.ctx.fillStyle="#FF0",this.ctx.fillRect(0,0,this.p.w,this.p.h/2),this.setFont(this.ctx),this.ctx.fillText(this.p.label,0,0))},draw:function(t){if(0!==this.p.opacity){this.p.oldLabel!==this.p.label&&this.calcSize(),this.setFont(t),void 0!==this.p.opacity&&(t.globalAlpha=this.p.opacity);for(var i=0;i<this.splitLabel.length;i++)"center"===this.p.align?(this.p.outlineWidth&&t.strokeText(this.splitLabel[i],0,-this.p.cy+i*this.p.size*1.2),t.fillText(this.splitLabel[i],0,-this.p.cy+i*this.p.size*1.2)):"right"===this.p.align?(this.p.outlineWidth&&t.strokeText(this.splitLabel[i],this.p.cx,-this.p.cy+i*this.p.size*1.2),t.fillText(this.splitLabel[i],this.p.cx,-this.p.cy+i*this.p.size*1.2)):(this.p.outlineWidth&&t.strokeText(this.splitLabel[i],-this.p.cx,-this.p.cy+i*this.p.size*1.2),t.fillText(this.splitLabel[i],-this.p.cx,-this.p.cy+i*this.p.size*1.2))}},asset:function(){return this.el},setFont:function(t){t.textBaseline="top",t.font=this.font(),t.fillStyle=this.p.color||"black",t.textAlign=this.p.align||"left",t.strokeStyle=this.p.outlineColor||"black",t.lineWidth=this.p.outlineWidth||0},font:function(){return this.fontString?this.fontString:(this.fontString=(this.p.weight||"800")+" "+(this.p.size||24)+"px "+(this.p.family||"Arial"),this.fontString)}}),t.UI.Button=t.UI.Container.extend("UI.Button",{init:function(i,e){if(this._super(t._defaults(i,{type:t.SPRITE_UI|t.SPRITE_DEFAULT})),this.p.label&&(!this.p.w||!this.p.h)){t.ctx.save(),this.setFont(t.ctx);var s=t.ctx.measureText(this.p.label);t.ctx.restore(),this.p.h||(this.p.h=44),this.p.w||(this.p.w=s.width+20)}isNaN(this.p.cx)&&(this.p.cx=this.p.w/2),isNaN(this.p.cy)&&(this.p.cy=this.p.h/2),this.callback=e,this.on("touch",this,"highlight"),this.on("touchEnd",this,"push")},highlight:function(){(!this.sheet()||this.sheet().frames>1)&&(this.p.frame=1)},push:function(){this.p.frame=0,this.callback&&this.callback(),this.trigger("click")},draw:function(i){this._super(i),(this.p.asset||this.p.sheet)&&t.Sprite.prototype.draw.call(this,i),this.p.label&&(i.save(),this.setFont(i),i.fillText(this.p.label,0,0),i.restore())},setFont:function(t){t.textBaseline="middle",t.font=this.p.font||"400 24px arial",t.fillStyle=this.p.fontColor||"black",t.textAlign="center"
}}),t.UI.IFrame=t.Sprite.extend("UI.IFrame",{init:function(i){this._super(i,{opacity:1,type:t.SPRITE_UI|t.SPRITE_DEFAULT}),t.wrapper.style.overflow="hidden",this.iframe=document.createElement("IFRAME"),this.iframe.setAttribute("src",this.p.url),this.iframe.style.position="absolute",this.iframe.style.zIndex=500,this.iframe.setAttribute("width",this.p.w),this.iframe.setAttribute("height",this.p.h),this.iframe.setAttribute("frameborder",0),this.p.background&&(this.iframe.style.backgroundColor=this.p.background),t.wrapper.appendChild(this.iframe),this.on("inserted",function(t){this.positionIFrame(),t.on("destroyed",this,"remove")})},positionIFrame:function(){var t=this.p.x,i=this.p.y;this.stage.viewport&&(t-=this.stage.viewport.x,i-=this.stage.viewport.y),(this.oldX!==t||this.oldY!==i||this.oldOpacity!==this.p.opacity)&&(this.iframe.style.top=i-this.p.cy+"px",this.iframe.style.left=t-this.p.cx+"px",this.iframe.style.opacity=this.p.opacity,this.oldX=t,this.oldY=i,this.oldOpacity=this.p.opacity)},step:function(t){this._super(t),this.positionIFrame()},remove:function(){this.iframe&&(t.wrapper.removeChild(this.iframe),this.iframe=null)}}),t.UI.HTMLElement=t.Sprite.extend("UI.HTMLElement",{init:function(i){this._super(i,{opacity:1,type:t.SPRITE_UI}),t.wrapper.style.overflow="hidden",this.el=document.createElement("div"),this.el.innerHTML=this.p.html,t.wrapper.appendChild(this.el),this.on("inserted",function(t){this.position(),t.on("destroyed",this,"remove"),t.on("clear",this,"remove")})},position:function(){},step:function(t){this._super(t),this.position()},remove:function(){this.el&&(t.wrapper.removeChild(this.el),this.el=null)}}),t.UI.VerticalLayout=t.Sprite.extend("UI.VerticalLayout",{init:function(t){this.children=[],this._super(t,{type:0})},insert:function(t){return this.stage.insert(t,this),this.relayout(),t},relayout:function(){for(var t=0,i=0;i<this.children.length;i++)t+=this.children[i].p.h||0;this.p.h-t}})};
